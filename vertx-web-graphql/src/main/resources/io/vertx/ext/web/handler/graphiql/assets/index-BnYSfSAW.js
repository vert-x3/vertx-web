function d(e){return e===null?"null":Array.isArray(e)?"array":typeof e}function b(e){return d(e)==="object"}function v(e){return Array.isArray(e)&&e.length>0&&e.every(m=>"message"in m)}function U(e,m){return e.length<124?e:m}const ee="graphql-transport-ws";var l=(e=>(e[e.InternalServerError=4500]="InternalServerError",e[e.InternalClientError=4005]="InternalClientError",e[e.BadRequest=4400]="BadRequest",e[e.BadResponse=4004]="BadResponse",e[e.Unauthorized=4401]="Unauthorized",e[e.Forbidden=4403]="Forbidden",e[e.SubprotocolNotAcceptable=4406]="SubprotocolNotAcceptable",e[e.ConnectionInitialisationTimeout=4408]="ConnectionInitialisationTimeout",e[e.ConnectionAcknowledgementTimeout=4504]="ConnectionAcknowledgementTimeout",e[e.SubscriberAlreadyExists=4409]="SubscriberAlreadyExists",e[e.TooManyInitialisationRequests=4429]="TooManyInitialisationRequests",e))(l||{}),f=(e=>(e.ConnectionInit="connection_init",e.ConnectionAck="connection_ack",e.Ping="ping",e.Pong="pong",e.Subscribe="subscribe",e.Next="next",e.Error="error",e.Complete="complete",e))(f||{});function J(e){if(!b(e))throw new Error(`Message is expected to be an object, but got ${d(e)}`);if(!e.type)throw new Error("Message is missing the 'type' property");if(typeof e.type!="string")throw new Error(`Message is expects the 'type' property to be a string, but got ${d(e.type)}`);switch(e.type){case"connection_init":case"connection_ack":case"ping":case"pong":{if(e.payload!=null&&!b(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object or nullish or missing, but got "${e.payload}"`);break}case"subscribe":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${d(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!b(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${d(e.payload)}`);if(typeof e.payload.query!="string")throw new Error(`"${e.type}" message payload expects the 'query' property to be a string, but got ${d(e.payload.query)}`);if(e.payload.variables!=null&&!b(e.payload.variables))throw new Error(`"${e.type}" message payload expects the 'variables' property to be a an object or nullish or missing, but got ${d(e.payload.variables)}`);if(e.payload.operationName!=null&&d(e.payload.operationName)!=="string")throw new Error(`"${e.type}" message payload expects the 'operationName' property to be a string or nullish or missing, but got ${d(e.payload.operationName)}`);if(e.payload.extensions!=null&&!b(e.payload.extensions))throw new Error(`"${e.type}" message payload expects the 'extensions' property to be a an object or nullish or missing, but got ${d(e.payload.extensions)}`);break}case"next":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${d(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!b(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an object, but got ${d(e.payload)}`);break}case"error":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${d(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);if(!v(e.payload))throw new Error(`"${e.type}" message expects the 'payload' property to be an array of GraphQL errors, but got ${JSON.stringify(e.payload)}`);break}case"complete":{if(typeof e.id!="string")throw new Error(`"${e.type}" message expects the 'id' property to be a string, but got ${d(e.id)}`);if(!e.id)throw new Error(`"${e.type}" message requires a non-empty 'id' property`);break}default:throw new Error(`Invalid message 'type' property "${e.type}"`)}return e}function te(e,m){return J(typeof e=="string"?JSON.parse(e,m):e)}function I(e,m){return J(e),JSON.stringify(e,m)}function ie(e){const{url:m,connectionParams:P,lazy:Q=!0,onNonLazyError:H=console.error,lazyCloseTimeout:A=0,keepAlive:R=0,disablePong:K,connectionAckWaitTimeout:O=0,retryAttempts:z=5,retryWait:V=async function(i){const t=Math.pow(2,i);await new Promise(n=>setTimeout(n,t*1e3+Math.floor(Math.random()*2700+300)))},shouldRetry:X=M,on:c,webSocketImpl:q,generateID:Y=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const t=Math.random()*16|0;return(i=="x"?t:t&3|8).toString(16)})},jsonMessageReplacer:W,jsonMessageReviver:Z}=e;let h;if(q){if(!ne(q))throw new Error("Invalid WebSocket implementation provided");h=q}else typeof WebSocket<"u"?h=WebSocket:typeof global<"u"?h=global.WebSocket||global.MozWebSocket:typeof window<"u"&&(h=window.WebSocket||window.MozWebSocket);if(!h)throw new Error("WebSocket implementation missing; on Node you can `import WebSocket from 'ws';` and pass `webSocketImpl: WebSocket` to `createClient`");const x=h,p=(()=>{const r=(()=>{const t={};return{on(n,s){return t[n]=s,()=>{delete t[n]}},emit(n){"id"in n&&t[n.id]?.(n)}}})(),i={connecting:c?.connecting?[c.connecting]:[],opened:c?.opened?[c.opened]:[],connected:c?.connected?[c.connected]:[],ping:c?.ping?[c.ping]:[],pong:c?.pong?[c.pong]:[],message:c?.message?[r.emit,c.message]:[r.emit],closed:c?.closed?[c.closed]:[],error:c?.error?[c.error]:[]};return{onMessage:r.on,on(t,n){const s=i[t];return s.push(n),()=>{s.splice(s.indexOf(n),1)}},emit(t,...n){for(const s of[...i[t]])s(...n)}}})();function B(r){const i=[p.on("error",t=>{i.forEach(n=>n()),r(t)}),p.on("closed",t=>{i.forEach(n=>n()),r(t)})]}let g,w=0,F,k=!1,N=0,L=!1;async function j(){clearTimeout(F);const[r,i]=await(g??(g=new Promise((s,y)=>(async()=>{if(k){if(await V(N),!w)return g=void 0,y({code:1e3,reason:"All Subscriptions Gone"});N++}p.emit("connecting",k);const o=new x(typeof m=="function"?await m():m,ee);let E,$;function T(){isFinite(R)&&R>0&&(clearTimeout($),$=setTimeout(()=>{o.readyState===x.OPEN&&(o.send(I({type:f.Ping})),p.emit("ping",!1,void 0))},R))}B(u=>{g=void 0,clearTimeout(E),clearTimeout($),y(u),u instanceof D&&(o.close(4499,"Terminated"),o.onerror=null,o.onclose=null)}),o.onerror=u=>p.emit("error",u),o.onclose=u=>p.emit("closed",u),o.onopen=async()=>{try{p.emit("opened",o);const u=typeof P=="function"?await P():P;if(o.readyState!==x.OPEN)return;o.send(I(u?{type:f.ConnectionInit,payload:u}:{type:f.ConnectionInit},W)),isFinite(O)&&O>0&&(E=setTimeout(()=>{o.close(l.ConnectionAcknowledgementTimeout,"Connection acknowledgement timeout")},O)),T()}catch(u){p.emit("error",u),o.close(l.InternalClientError,U(u instanceof Error?u.message:String(u),"Internal client error"))}};let S=!1;o.onmessage=({data:u})=>{try{const a=te(u,Z);if(p.emit("message",a),a.type==="ping"||a.type==="pong"){p.emit(a.type,!0,a.payload),a.type==="pong"?T():K||(o.send(I(a.payload?{type:f.Pong,payload:a.payload}:{type:f.Pong})),p.emit("pong",!1,a.payload));return}if(S)return;if(a.type!==f.ConnectionAck)throw new Error(`First message cannot be of type ${a.type}`);clearTimeout(E),S=!0,p.emit("connected",o,a.payload,k),k=!1,N=0,s([o,new Promise((oe,C)=>B(C))])}catch(a){o.onmessage=null,p.emit("error",a),o.close(l.BadResponse,U(a instanceof Error?a.message:String(a),"Bad response"))}}})())));r.readyState===x.CLOSING&&await i;let t=()=>{};const n=new Promise(s=>t=s);return[r,t,Promise.race([n.then(()=>{if(!w){const s=()=>r.close(1e3,"Normal Closure");isFinite(A)&&A>0?F=setTimeout(()=>{r.readyState===x.OPEN&&s()},A):s()}}),i])]}function _(r){if(M(r)&&(re(r.code)||[l.InternalServerError,l.InternalClientError,l.BadRequest,l.BadResponse,l.Unauthorized,l.SubprotocolNotAcceptable,l.SubscriberAlreadyExists,l.TooManyInitialisationRequests].includes(r.code)))throw r;if(L)return!1;if(M(r)&&r.code===1e3)return w>0;if(!z||N>=z||!X(r))throw r;return k=!0}Q||(async()=>{for(w++;;)try{const[,,r]=await j();await r}catch(r){try{if(!_(r))return}catch(i){return H?.(i)}}})();function G(r,i){const t=Y(r);let n=!1,s=!1,y=()=>{w--,n=!0};return(async()=>{for(w++;;)try{const[o,E,$]=await j();if(n)return E();const T=p.onMessage(t,S=>{switch(S.type){case f.Next:{i.next(S.payload);return}case f.Error:{s=!0,n=!0,i.error(S.payload),y();return}case f.Complete:{n=!0,y();return}}});o.send(I({id:t,type:f.Subscribe,payload:r},W)),y=()=>{!n&&o.readyState===x.OPEN&&o.send(I({id:t,type:f.Complete},W)),w--,n=!0,E()},await $.finally(T);return}catch(o){if(!_(o))return}})().then(()=>{s||i.complete()}).catch(o=>{i.error(o)}),()=>{n||y()}}return{on:p.on,subscribe:G,iterate(r){const i=[],t={done:!1,error:null,resolve:()=>{}},n=G(r,{next(y){i.push(y),t.resolve()},error(y){t.done=!0,t.error=y,t.resolve()},complete(){t.done=!0,t.resolve()}}),s=(async function*(){for(;;){for(i.length||await new Promise(o=>t.resolve=o);i.length;)yield i.shift();if(t.error)throw t.error;if(t.done)return}})();return s.throw=async y=>(t.done||(t.done=!0,t.error=y,t.resolve()),{done:!0,value:void 0}),s.return=async()=>(n(),{done:!0,value:void 0}),s},async dispose(){if(L=!0,g){const[r]=await g;r.close(1e3,"Normal Closure")}},terminate(){g&&p.emit("closed",new D)}}}class D extends Error{name="TerminatedCloseEvent";message="4499: Terminated";code=4499;reason="Terminated";wasClean=!1}function M(e){return b(e)&&"code"in e&&"reason"in e}function re(e){return[1e3,1001,1006,1005,1012,1013,1014].includes(e)?!1:e>=1e3&&e<=1999}function ne(e){return typeof e=="function"&&"constructor"in e&&"CLOSED"in e&&"CLOSING"in e&&"CONNECTING"in e&&"OPEN"in e}export{l as CloseCode,ee as GRAPHQL_TRANSPORT_WS_PROTOCOL,f as MessageType,D as TerminatedCloseEvent,ie as createClient,te as parseMessage,I as stringifyMessage,J as validateMessage};
